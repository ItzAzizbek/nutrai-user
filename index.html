<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Azizbek Calories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: white;
            /* Use dvh for mobile browsers to account for address bars */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
        }

        /* Camera Viewfinder Animation */
        .scanner-overlay {
            position: absolute;
            top: 45%; /* Slightly higher than center for better ergonomics */
            left: 50%;
            transform: translate(-50%, -50%);
            /* Responsive square: 70% of viewport width on mobile, capped at 320px */
            width: 70vw;
            height: 70vw;
            max-width: 320px;
            max-height: 320px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #22c55e; /* Green-500 */
            border-style: solid;
            transition: all 0.3s ease;
        }

        .scanner-corner.top-left { top: -2px; left: -2px; border-width: 4px 0 0 4px; border-radius: 24px 0 0 0; }
        .scanner-corner.top-right { top: -2px; right: -2px; border-width: 4px 4px 0 0; border-radius: 0 24px 0 0; }
        .scanner-corner.bottom-left { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; border-radius: 0 0 0 24px; }
        .scanner-corner.bottom-right { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; border-radius: 0 0 24px 0; }

        .scan-line {
            width: 100%;
            height: 2px;
            background: #22c55e;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 10px #22c55e;
            opacity: 0.6;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Glassmorphism for panels */
        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .shutter-btn {
            transition: transform 0.1s ease;
        }

        .shutter-btn:active {
            transform: scale(0.9);
        }

        /* Hide scrollbars but keep functionality */
        .no-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="relative bg-black">

    <!-- Header -->
    <header class="absolute top-0 left-0 w-full z-20 p-4 md:p-6 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="bg-green-500/10 p-2 rounded-full backdrop-blur-sm">
                <i class="ph-fill ph-plant text-green-500 text-xl md:text-2xl"></i>
            </div>
            <h1 class="text-lg md:text-xl font-bold tracking-tight text-white drop-shadow-md">Azizbek Calories</h1>
        </div>
        <div class="bg-black/40 backdrop-blur-md px-3 py-1.5 rounded-full text-xs font-medium border border-white/10 shadow-lg pointer-events-auto">
            <span id="status-indicator" class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                Camera Off
            </span>
        </div>
    </header>

    <!-- Main Camera Area -->
    <main class="w-full h-full relative flex items-center justify-center overflow-hidden bg-gray-900">
        
        <!-- Video Element - object-cover ensures full screen fill -->
        <video id="camera-feed" class="absolute w-full h-full object-cover" autoplay playsinline muted></video>
        <canvas id="capture-canvas" class="hidden"></canvas>

        <!-- Placeholder/Initial State -->
        <div id="camera-placeholder" class="z-10 text-center p-6 w-full max-w-sm relative">
            <div class="bg-gray-800/80 rounded-full p-8 inline-block mb-6 shadow-2xl backdrop-blur-sm">
                <i class="ph ph-camera-slash text-5xl text-gray-400"></i>
            </div>
            <h2 class="text-2xl font-bold mb-3">Camera Access Needed</h2>
            <p class="text-gray-300 text-base mb-8 px-4 leading-relaxed">Allow camera access to scan your food for instant AI nutritional analysis.</p>
            <button onclick="startCamera()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-4 rounded-full font-bold text-lg transition-all shadow-lg shadow-green-900/40 active:scale-95 w-full md:w-auto">
                Enable Camera
            </button>
        </div>

        <!-- Scanner Overlay (Hidden initially) -->
        <div id="viewfinder" class="scanner-overlay hidden">
            <div class="scanner-corner top-left"></div>
            <div class="scanner-corner top-right"></div>
            <div class="scanner-corner bottom-left"></div>
            <div class="scanner-corner bottom-right"></div>
            <div class="scan-line"></div>
        </div>

    </main>

    <!-- Controls / Results Panel -->
    <div id="bottom-panel" class="absolute bottom-0 w-full z-30 glass-panel rounded-t-[32px] transition-transform duration-500 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        
        <!-- Shutter Area (Default View) -->
        <!-- Max-width container to keep controls centered on tablets/desktop -->
        <div id="shutter-controls" class="w-full max-w-md mx-auto p-6 pb-12 md:pb-12 flex justify-between items-center px-12 md:px-16">
            <button onclick="toggleFlash()" class="p-4 rounded-full bg-white/5 hover:bg-white/10 active:bg-white/20 text-white transition-colors" title="Toggle Flash">
                 <i class="ph ph-lightning text-2xl"></i>
            </button>
            
            <button onclick="captureAndAnalyze()" id="shutter-btn" class="shutter-btn w-20 h-20 md:w-24 md:h-24 rounded-full border-[5px] border-white flex items-center justify-center bg-transparent relative shadow-lg">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-white rounded-full"></div>
            </button>
            
            <button onclick="flipCamera()" class="p-4 rounded-full bg-white/5 hover:bg-white/10 active:bg-white/20 text-white transition-colors" title="Switch Camera">
                <i class="ph ph-camera-rotate text-2xl"></i>
            </button>
        </div>

        <!-- Analysis Loading State -->
        <div id="loading-state" class="hidden w-full max-w-md mx-auto p-10 text-center pb-16">
            <div class="relative inline-block mb-4">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-white/20 border-t-green-500"></div>
            </div>
            <p class="text-xl font-bold animate-pulse text-white">Analyzing...</p>
            <p class="text-sm text-green-400 mt-2 font-medium">Consulting Gemini AI</p>
        </div>

        <!-- Results View -->
        <!-- Max height constraint ensures it doesn't take over full screen on mobile -->
        <div id="results-content" class="hidden w-full max-w-2xl mx-auto p-6 pb-12 max-h-[75dvh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-start mb-6 sticky top-0 bg-[#0f172ae6] backdrop-blur-xl z-10 py-2 -mt-2">
                <div>
                    <h2 id="food-name" class="text-2xl md:text-3xl font-bold text-white mb-1 leading-tight">Detected Food</h2>
                    <p id="food-confidence" class="text-sm text-green-400 flex items-center gap-1.5 font-medium">
                        <i class="ph-fill ph-check-circle"></i> AI Analysis Complete
                    </p>
                </div>
                <button onclick="resetScanner()" class="bg-gray-700/50 hover:bg-gray-600 p-2.5 rounded-full transition-colors backdrop-blur-md">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <!-- Macros Grid -->
            <div class="grid grid-cols-4 gap-2 md:gap-4 mb-6">
                <div class="bg-gray-800/60 p-3 rounded-2xl text-center border border-white/5 shadow-inner">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400 mb-1 font-semibold">Cals</div>
                    <div id="val-cals" class="text-lg md:text-xl font-bold text-white">--</div>
                </div>
                <div class="bg-blue-900/20 p-3 rounded-2xl text-center border border-blue-500/20">
                    <div class="text-[10px] uppercase tracking-wider text-blue-300 mb-1 font-semibold">Protein</div>
                    <div id="val-protein" class="text-lg md:text-xl font-bold text-blue-400">--</div>
                </div>
                <div class="bg-yellow-900/20 p-3 rounded-2xl text-center border border-yellow-500/20">
                    <div class="text-[10px] uppercase tracking-wider text-yellow-300 mb-1 font-semibold">Carbs</div>
                    <div id="val-carbs" class="text-lg md:text-xl font-bold text-yellow-400">--</div>
                </div>
                <div class="bg-red-900/20 p-3 rounded-2xl text-center border border-red-500/20">
                    <div class="text-[10px] uppercase tracking-wider text-red-300 mb-1 font-semibold">Fat</div>
                    <div id="val-fat" class="text-lg md:text-xl font-bold text-red-400">--</div>
                </div>
            </div>

            <!-- Details -->
            <div class="space-y-4">
                <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                    <h3 class="font-semibold mb-2 flex items-center gap-2 text-gray-200">
                        <i class="ph-fill ph-info text-blue-400"></i> Description
                    </h3>
                    <p id="food-desc" class="text-sm md:text-base text-gray-400 leading-relaxed">
                        Analysis pending...
                    </p>
                </div>

                 <div class="bg-green-500/10 p-5 rounded-2xl border border-green-500/20">
                    <h3 class="font-semibold mb-2 flex items-center gap-2 text-green-400">
                        <i class="ph-fill ph-heartbeat"></i> Health Tip
                    </h3>
                    <p id="food-health" class="text-sm md:text-base text-green-100/90 leading-relaxed font-medium">
                        Eating healthy is a journey, not a destination.
                    </p>
                </div>
            </div>
            
            <button onclick="resetScanner()" class="w-full mt-8 bg-white text-black font-bold py-4 rounded-2xl hover:bg-gray-200 active:scale-[0.98] transition-all shadow-xl">
                Scan Next Item
            </button>
            <div class="h-8"></div> <!-- Spacer for bottom safe area -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-red-500/90 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px] z-50 text-sm font-medium w-max max-w-[90vw] text-center">
        Error message
    </div>

    <script>
        // --- Configuration ---
        const apiKey = "AIzaSyDB_i1dPpmmk-_Uyj0rh1Y0WVTtANrZDLo"; 
        let stream = null;
        let isProcessing = false;
        let currentFacingMode = 'environment'; // Default to rear camera on mobile

        // --- DOM Elements ---
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const placeholder = document.getElementById('camera-placeholder');
        const shutterControls = document.getElementById('shutter-controls');
        const loadingState = document.getElementById('loading-state');
        const resultsContent = document.getElementById('results-content');
        const viewfinder = document.getElementById('viewfinder');
        const statusIndicator = document.getElementById('status-indicator');

        // --- Camera Logic ---
        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Mobile-first constraints
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 }, // Try for high res
                        height: { ideal: 1080 } 
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to load to show UI
                video.onloadedmetadata = () => {
                    placeholder.classList.add('hidden');
                    viewfinder.classList.remove('hidden');
                    updateStatus(true);
                };

            } catch (err) {
                console.error("Camera Error:", err);
                showToast("Could not access camera. Please allow permissions.");
                updateStatus(false);
            }
        }

        function flipCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            startCamera();
        }

        function updateStatus(active) {
            if (active) {
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span> Live';
            } else {
                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Camera Off';
            }
        }

        // --- API Integration ---
        async function captureAndAnalyze() {
            if (isProcessing) return;
            isProcessing = true;

            // UI Updates
            shutterControls.classList.add('hidden');
            loadingState.classList.remove('hidden');
            viewfinder.style.borderColor = 'rgba(255,255,255,0.8)'; // Freeze effect hint
            viewfinder.querySelector('.scan-line').style.display = 'none'; // Stop scan line

            // Capture Frame
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get Base64 (remove prefix)
            const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1]; // Lower quality slightly for speed

            try {
                const result = await callGeminiAPI(base64Data);
                displayResults(result);
            } catch (error) {
                console.error(error);
                showToast("AI Analysis Failed. Try again.");
                resetScanner();
            }
        }

        async function callGeminiAPI(base64Image) {
            const prompt = `
                Analyze this image of food. Identify the food item. 
                Estimate the nutritional content for the visible portion size.
                Return ONLY a valid JSON object with no markdown formatting.
                Structure:
                {
                    "name": "Food Name",
                    "calories": "Number (e.g. 350)",
                    "protein": "String (e.g. 20g)",
                    "carbs": "String",
                    "fat": "String",
                    "description": "Short description of the food and estimated portion.",
                    "health_tip": "A one-sentence quick health fact or tip about this food."
                }
                If no food is clearly visible, return { "error": "No food detected" }.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            // Retry logic with exponential backoff
            let attempt = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (attempt <= maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error("Empty response from AI");

                    return JSON.parse(text);

                } catch (e) {
                    attempt++;
                    if (attempt > maxRetries) throw e;
                    await new Promise(resolve => setTimeout(resolve, delays[attempt - 1]));
                }
            }
        }

        // --- UI Logic ---
        function displayResults(data) {
            loadingState.classList.add('hidden');
            
            if (data.error) {
                showToast(data.error);
                resetScanner();
                return;
            }

            resultsContent.classList.remove('hidden');

            // Populate Data
            document.getElementById('food-name').innerText = data.name || "Unknown Food";
            document.getElementById('val-cals').innerText = data.calories || "--";
            document.getElementById('val-protein').innerText = data.protein || "--";
            document.getElementById('val-carbs').innerText = data.carbs || "--";
            document.getElementById('val-fat').innerText = data.fat || "--";
            document.getElementById('food-desc').innerText = data.description || "No description available.";
            document.getElementById('food-health').innerText = data.health_tip || "Eat balanced meals!";
        }

        function resetScanner() {
            isProcessing = false;
            resultsContent.classList.add('hidden');
            loadingState.classList.add('hidden');
            shutterControls.classList.remove('hidden');
            
            // Reset visual cues
            viewfinder.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            viewfinder.querySelector('.scan-line').style.display = 'block';
        }

        function toggleFlash() {
            // Simulated flash animation
            const flash = document.createElement('div');
            flash.className = 'fixed inset-0 bg-white z-50 pointer-events-none transition-opacity duration-300';
            document.body.appendChild(flash);
            
            // Fade out
            requestAnimationFrame(() => {
                flash.style.opacity = '0';
            });
            setTimeout(() => flash.remove(), 300);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        // --- Initialization ---
        window.addEventListener('load', () => {
            // Check if we can autoplay, otherwise show button
            // Most modern browsers block autoplay with sound, but muted is usually ok.
            // We leave the placeholder visible until startCamera() succeeds.
        });

    </script>
</body>
</html>